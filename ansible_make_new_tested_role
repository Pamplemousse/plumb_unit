#!/bin/bash

if [ $# -lt 1 ] ; then
  echo "le nom du rôle doit être passé en paramètre." >&2
  exit 1
fi
role=$1

tools=$(readlink -f $(dirname $0))
base_dir=$(readlink -f .)
role_dir=${base_dir}/roles/${role}
mkdir -p ${role_dir}/{tasks,tests}

run_test="run_tests.sh"
bash_unit="bash_unit"
ansible_cfg="ansible.cfg"

cd ${role_dir}/tasks

[ -f main.yml ] || touch main.yml

cd ${role_dir}/tests

[ -f ${run_test} ] || cp ${tools}/${run_test} .
[ -f ${bash_unit} ] || bash <(curl -Ss https://raw.githubusercontent.com/pgrange/bash_unit/master/install.sh) >/dev/null 2>&1
[ -f ${ansible_cfg} ] || cp ${tools}/${ansible_cfg} .

[ -x ${run_test} ] || chmod +x ${run_test}
[ -x ${bash_unit} ] || chmod +x ${run_test}

if [ ! -f "test_${role}" ]
then
  cat << __EOF__ >test_${role}
#!/bin/bash

test_failed() {
  run_ansible 
  assert_equals "false" "true"
}

setup() {
  mkdir /tmp/ansible/group_vars -p

  cat << EOF > /tmp/ansible/playbook.yml
- hosts: all
  roles:
    - role: ${role}
EOF
}

run_ansible() {
  assert "sudo -u rpaulson ansible-playbook --verbose --diff -i 'localhost,' --connection=local /tmp/ansible/playbook.yml"
}

__EOF__
fi

echo "role [${role}] created" >&2
echo "to run tests :" >&2
echo -e "\tcd $(dirname $(pwd))
\t./tests/run_tests.sh" >&2

cd ${base_dir}
